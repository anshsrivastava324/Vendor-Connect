<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Confirmation - Vendor Connect</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/auth.css">
    <script src="../js/animations.js" defer></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card animate-on-scroll">
            <div class="auth-header">
                <h1>Email Confirmation</h1>
                <p id="confirmationMessage">Confirming your email address...</p>
            </div>
            
            <div id="confirmationResult" class="confirmation-result animate-on-scroll">
                <div class="spinner">
                    <div class="spinner-icon">‚è≥</div>
                    <p>Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/supabase-client.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenHash = urlParams.get('token_hash');
            const type = urlParams.get('type');
            const redirectTo = urlParams.get('redirect_to');

            const messageEl = document.getElementById('confirmationMessage');
            const resultEl = document.getElementById('confirmationResult');

            if (tokenHash && type === 'signup') {
                try {
                    const response = await fetch(`${SUPABASE_URL}/auth/v1/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({
                            token_hash: tokenHash,
                            type: type
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.user) {
                        messageEl.textContent = '‚úÖ Email confirmed successfully!';
                        resultEl.innerHTML = `
                            <div class="success-message animate-on-scroll">
                                <div class="success-icon">üéâ</div>
                                <h3>Welcome to Vendor Connect!</h3>
                                <p>Your email has been verified successfully. You can now log in to your account.</p>
                                <div class="button-group">
                                    <a href="../vendor-login.html" class="btn btn-primary hover-lift">Login as Vendor</a>
                                    <a href="../supplier-login.html" class="btn btn-secondary hover-lift">Login as Supplier</a>
                                </div>
                                <p class="redirect-info">You will be redirected automatically in <span id="countdown">5</span> seconds...</p>
                            </div>
                        `;

                        let seconds = 5;
                        const countdownEl = document.getElementById('countdown');
                        const countdownInterval = setInterval(() => {
                            seconds--;
                            if (countdownEl) countdownEl.textContent = seconds;
                            if (seconds <= 0) {
                                clearInterval(countdownInterval);
                                window.location.href = redirectTo || '../vendor-login.html';
                            }
                        }, 1000);

                    } else {
                        throw new Error(result.error?.message || 'Email confirmation failed');
                    }
                } catch (error) {
                    messageEl.textContent = '‚ùå Email confirmation failed';
                    resultEl.innerHTML = `
                        <div class="error-message animate-on-scroll">
                            <div class="error-icon">‚ö†Ô∏è</div>
                            <h3>Confirmation Failed</h3>
                            <p>${error.message}</p>
                            <div class="button-group">
                                <a href="../register.html" class="btn btn-primary hover-lift">Register Again</a>
                                <a href="../index.html" class="btn btn-secondary hover-lift">Go Home</a>
                            </div>
                        </div>
                    `;
                }
            } else {
                messageEl.textContent = '‚ùå Invalid confirmation link';
                resultEl.innerHTML = `
                    <div class="error-message animate-on-scroll">
                        <div class="error-icon">üö´</div>
                        <h3>Invalid Link</h3>
                        <p>This confirmation link is invalid or expired.</p>
                        <div class="button-group">
                            <a href="../register.html" class="btn btn-primary hover-lift">Register Again</a>
                            <a href="../index.html" class="btn btn-secondary hover-lift">Go Home</a>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
